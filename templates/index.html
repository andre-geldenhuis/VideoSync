<!DOCTYPE html>
<html lang="en">
<head>
    <title>Video Sync</title>
    <link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css">

    <style type="text/css">

    .span12{
    	background: black;
    	color: white;
    	padding: 20px 0;
    	text-align:center;
	}

    .span6, .span4{
		background: blue;
		color: white;
		padding: 20px 0;
		text-align:center;
		margin-top: 15px;
	}

	.span3{
    	background: purple;
    	color: white;
    	padding: 0px 0;
    	text-align:center;
    	margin-top: 15px;

	}
	.span8{
    	background: pink;
    	color: white;
    	padding: 0px 0;
    	text-align:center;
		margin-top: 15px;
	}

	.span5, .span7, .span2{
    	background: yellow;
    	color: black;
    	padding: 20px 0;
    	text-align:center;
		margin-top: 15px;
	}

	</style>

</head>

<body>

	<div class="container">

		<div class="row">
			<div class="span12">
				<h1>Video Sync</h1>
			</div>
		</div>

		<div class="row">
				<div class="span6">
		            <div id="iframe-1" data-source={{video1.youtube_url}} data-sync={{video1.analysis_track.sync_point}} data-status="notPlaying"></div>               
		            <div>
		            	<h6> youtube url: {{video1.youtube_url}} </h6>
		            </div>
		        </div>
		        <div class="span6">
		            <div id="iframe-2" data-source={{video2.youtube_url}} data-sync={{video2.analysis_track.sync_point}} data-status="notPlaying"></div>
		            <div>
		            	<h6> youtube url: {{video2.youtube_url}} </h6>
		            </div>
		        </div>
		</div>

		<div class="row">
			<div class="span4">
				Title: {{video1.title}}
				Artist: {{video1.artist}}
				Event: {{video1.event}}
			</div>
			<div class="span8">
				<button id="playAll" class="btn" disabled>Play</button>
        		<button id="pauseAll" class="btn" disabled>Pause</button>
			</div>
		</div>	


		<div class="row">
			<div class="span8">
				<form class="form-horizontal">
					<div class="control-group">
						<label class="control-label" for="title">Title</label>
						<div class="controls">
							<input type="text" class="span3" name="title" placeholder="Title"/><br/>
						</div>
					</div>
					<div class="control-group">
				        <label class="control-label" for="artist">Artist</label>
						<div class="controls">
				        	<input type="text" class="span3" name="artist" placeholder="Artist"/><br/>
						</div>
					</div>

					<div class="control-group">
				        <label class="control-label" for="event">Event</label>
						<div class="controls">
				        	<input type="text" class="span3" name="event" placeholder="Event"/><br/>
						</div>
					</div>

				        <input type="file" class="span3" name="file1"><br/>
				        <input type="file" class="span3" name="file2"><br/>

				        <label class="control-label" for="url1">Youtube URL</label>
				        <input type="text" class="span3" name="url1" placeholder="Youtube URL"><br/>
				        <label class="control-label" for="url2">Youtube URL</label>
				        <input type="text" class="span3" name="url2" placeholder="Youtube URL"><br/>

				        <button class="btn btn-primary" type="submit">Upload</button>
				   
			    </form>
			</div>
			<div class="span4">
				{% for group in groups %}
					<div class="span2">
			            <h3>Group:{{group.id}}</h3>
			            {% for analysis in group.analysis_group %}
			                <h4>Sync Point:{{analysis.sync_point}}</h4>
			                <h4>Track:{{analysis.analysis_track.filename}}</h4>
			            {% endfor %}
			            <a href="/view_event?group_id={{group.id}}">View video group {{group.id}}</a>
		         	</div>
		        {% endfor %}
		    </div>
		</div>

	</div>










	</div>

    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script type="text/javascript">

        // Youtube iframe API
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player1, player2;
        var playButton, pauseButton;

        function init() {
        playButton = $("#playAll");
        pauseButton = $("#pauseAll");

        playButton.bind("click", onPlayClick);
        pauseButton.on("click", onPauseClick);
        }

        // Create YouTube Iframe elements
        function onYouTubeIframeAPIReady() { // create function that creates similar elements
            player1 = new YT.Player('iframe-1', {
                height: '350',
                width: '450',
                videoId: document.getElementById('iframe-1').getAttribute('data-source').split("embed/")[1],
                playerVars: {'autoplay': 0, 'controls': 1},
                events: {
                'onReady': onPlayerReady,
                // 'onStateChange': onPlayerStateChange
                }
            });

            player2 = new YT.Player('iframe-2', {
                height: '350',
                width: '450',
                videoId: document.getElementById('iframe-2').getAttribute('data-source').split("embed/")[1],
                playerVars: {'autoplay': 0, 'controls': 1},
                events: {
                'onReady': onPlayerReady,
                // 'onStateChange': onPlayerStateChange
                }
            });
        }


        // Enable Play and Pause buttons if player1 and player2 videos have loaded 2%
        function onPlayerReady(event) {
            event.target.setPlaybackQuality("small")
            event.target.playVideo()
            event.target.pauseVideo()
            window.setInterval(function() {
                // console.log(event.target.getVideoLoadedFraction());
                if (event.target.getVideoLoadedFraction() > .02) {
                    event.target.readyToPlayNow = "true";
                }

                if ((player1.readyToPlayNow == "true") && (player2.readyToPlayNow == "true")) {
                    playButton.removeAttr('disabled');
                    pauseButton.removeAttr('disabled');
                    // player1.playVideo();
                    // player2.playVideo();
                }
            }, 1000)
        }

        function onPlayClick(event) {
            var vFirst, vSecond;

            console.log(player1.getAttribute('data-sync'));
            console.log(player2['data-sync']);

            if (Number(player1['data-sync']) > (Number(player2['data-sync']))) {
                vFirst = player2;
                vSecond = player1;
            } else {
                vFirst = player1;
                vSecond = player2;
            }

            // Event listener
            vFirst.addEventListener("timeupdate", function() {
                if (((vFirst.getCurrentTime*1000) >= vSecond['data-sync']) &&(vSecond['data-status'] == 'notPlaying')){ 
                    vSecond.playVideo();
                    console.log('VIDEO PLAYING')
                    console.log(vFirst.getCurrentTime*1000)
                    vSecond['data-status'] = "playing";
                }
            })
            vFirst.playVideo();
            vFirst['data-status'] = 'playing';

            if ((vSecond['data-status'] == 'playing') && (vFirst['data-status'] == 'playing')) {
                vSecond.playVideo();
                vFirst.playVideo();
            }
        }
                  
        function onPauseClick(event) {
            player1.pauseVideo(); 
            player2.pauseVideo();
        }  
        



        // var done = false;
        // function onPlayerStateChange(event) {
        //     if (event.data == YT.PlayerState.PLAYING && !done) {
        //       setTimeout(startVideo, 4000);
        //       done = true;
        //     }
        // }

        // }
        // function startVideo() {
        //     // player.startVideo();
        // }







            // function init() {
 
            //     v1.on("canplaythrough", onPlayThrough);
            //     v2.on("canplaythrough", onPlayThrough);

            // }


              
       

            init();

            </script>
</body>
</html>