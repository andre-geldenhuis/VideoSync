<!DOCTYPE html>
<html lang="en">
<head>
    <title>Video Sync</title>

    <link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css">
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

    <style type="text/css">

    .container{
        background: #ffffff;
    }
    .span12{
    	text-align:center;
	}

    .span6, .span4{
		background: #ffffff;
        color: #000000;
		text-align:center;
		margin-top: 15px;
        margin-left: 30px;
	}

	.span3{
    	margin-top: 15px;
    }
    #videoInfo{
        color: #000000;
        text-align: right;
        padding-bottom: 0px;
        padding-left: 0px;
    }
    #buttonRow{
        padding-top: 10px;
        background: #ffffff;
    }
    #thumbnail-info{
        text-align: left;
        padding-left: 60px;
        margin-top: 0px;
    }
    #rightVideo, #leftVideo{
        margin-left: 0px;
        margin-right: 0px;

    }
    #uploadInfo{
        margin-right: 0px;
        text-align: left;
        padding-left: 60px;
        padding-right: 0px;
        background: #d6d6e1;
    }
    .controls{
        text-align: center;
    }
    #thumbRow{
        margin-left: 0px;
        margin-bottom: 15px;
    }
    #data-2{
        text-align: left;
        margin-left: 0px;
        background: #000000;

    }    
    #data-1{
        text-align: right;
        margin-right: 0px;
        margin-left: 45px;
        background: #000000;

    }
    #displayVideos{
        margin-top: -5px;
    }
    h6{
        line-height: 5px;
    }
    #header-text{
        margin-left: 45px;
        padding-left: 0px;
        padding-right: 0px;
        background: #d6d631;

    }







	


	</style>

</head>

<body>

	<div class="container">

		<div id="heading" class="row">
			<div id="header-text" class="span6">
				<h1>Video Sync</h1>
            </div>
            <div id="videoInfo" class="span5">
                <p> </p></br>
                Title: {{video1.title}} </br>
                Artist: {{video1.artist}} </br>
                Event: {{video1.event}} </br>
			</div>
		</div>
        <div class="row">


        </div>

		<div id="displayVideos" class="row">
				<div id="data-1" class="span6" data-source="{{video1.youtube_url}}" data-sync="{{video1.analysis_track[0].sync_point}}" data-status="notPlaying">
		            <div id="iframe-1"></div>               
		        </div>
		        <div id="data-2" class="span6" data-source="{{video2.youtube_url}}" data-sync="{{video2.analysis_track[0].sync_point}}" data-status="notPlaying">
		            <div id="iframe-2"></div>
		        </div>
		</div>

		<div class="row">
            <div id="buttonRow" class="span12">
                <button id="playAll" class="btn btn-primary" disabled><i class="icon-play icon-5x"></i></button>
                <button id="pauseAll" class="btn" disabled><i class="icon-pause icon-5x"></i></button>
            </div>
        </div>



		<div class="row">
			<div id="uploadInfo" class="span4">
                <h3>Synchronize a new video set</h3>
				<form class="form" method="post">
					<div class="control-group">
						<label class="control-label" for="title"></label>
						<div class="controls">
							<input type="text" class="span2" name="title" placeholder="Title"/><br/>
						</div>
					</div>
					<div class="control-group">
				        <label class="control-label" for="artist"></label>
						<div class="controls">
				        	<input type="text" class="span2" name="artist" placeholder="Artist"/><br/>
						</div>
					</div>

					<div class="control-group">
				        <label class="control-label" for="event"></label>
						<div class="controls">
				        	<input type="text" class="span2" name="event" placeholder="Event"/><br/>
						</div>
					</div>
                    <h5>Use a YouTube link</h5>
                    <div class="control-group">
                        <label class="control-label" for="url1"></label>
                        <div class="controls">
                            <input type="text" class="span3" name="url1" placeholder="Youtube URL"><br/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="url2"></label>
                        <div class="controls">
                            <input type="text" class="span3" name="url2" placeholder="Youtube URL"><br/>
                        </div>
                    </div>

                    <h5>or upload a video</h5>
                    <div class="control-group">
                        <label class="control-label" for="file1"></label>
                        <div class="controls">
                            <input type="file" class="span3" name="file1"><br/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="file2"></label>
                        <div class="controls">
                            <input type="file" class="span3" name="file2"><br/>
                        </div>
                    </div>






				        <button class="btn btn-primary" type="submit">Upload</button>
				   
			    </form>
			</div>
			<div class="span7">
				{% for group in groups %}
					<div id="thumbRow" class="row">
			            {% for analysis in group.analysis_group %}
                            {% if loop.index == 1 %}
                                <div id="leftVideo" class="span3">
                                <a href="/watch?group_id={{group.id}}"><img src="{{analysis.analysis_track.thumbnail_url}}" height="250" width="250" align="right"></img></a>
                                </div>
                            {% endif %}
                            {% if loop.index == 2 %}
                                <div id="rightVideo" class="span3">
                                <a href="/watch?group_id={{group.id}}"><img src="{{analysis.analysis_track.thumbnail_url}}" height="250" width="250" align="left"></img></a>
                                </div>
                                <div class="row">
                                    <div id="thumbnail-info" class="span6">
                                        <h6>{{analysis.analysis_track.title}}</h6>
                                        <h6>{{analysis.analysis_track.artist}}</h6>
                                        <h6>{{analysis.analysis_track.event}}</h6>

        			                    </a>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}

		         	</div>
                {% endfor %}

		    </div>
                           
		</div>

	</div>










	</div>

    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script type="text/javascript">

        // Youtube iframe API
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player1, player2, data1, data2;
        var playButton, pauseButton;




        function init() {
            data1 = $("#data-1");
            data2 = $("#data-2");
            playButton = $("#playAll");
            pauseButton = $("#pauseAll");

            playButton.on("click", onPlayClick);
            pauseButton.on("click", onPauseClick);
        }

        // Create YouTube Iframe elements
        function onYouTubeIframeAPIReady() { // create function that creates similar elements
            player1 = new YT.Player('iframe-1', {
                height: '400',
                width: '470',
                videoId: data1.attr('data-source').split("embed/")[1],
                playerVars: {'autoplay': 0, 'controls': 0},
                events: {
                'onReady': onPlayerReady,
                // 'onStateChange': onPlayerStateChange
                }
            });

            player2 = new YT.Player('iframe-2', {
                height: '400',
                width: '470',
                videoId: data2.attr('data-source').split("embed/")[1],
                playerVars: {'autoplay': 0, 'controls': 0},
                events: {
                'onReady': onPlayerReady,
                // 'onStateChange': onPlayerStateChange
                }
            });
        }


        // Enable Play and Pause buttons if player1 and player2 videos have loaded 2%
        function onPlayerReady(event) {
            event.target.setPlaybackQuality("small")
            event.target.playVideo()
            event.target.pauseVideo()
            window.setInterval(function() {
                // console.log(event.target.getVideoLoadedFraction());
                if (event.target.getVideoLoadedFraction() > .02) {
                    event.target.readyToPlayNow = "true";
                }

                if ((player1.readyToPlayNow == "true") && (player2.readyToPlayNow == "true")) {
                    playButton.removeAttr('disabled');
                    pauseButton.removeAttr('disabled');
                    // player1.playVideo();
                    // player2.playVideo();
                }
            }, 500)
        }

        function onPlayClick(event) {
            var vFirst, vSecond;

            if (Number(data1.attr("data-sync")) < (Number(data2.attr("data-sync")))) {
                vFirst = player1; // player element
                vFirstData = data1; // dom element
                vSecond = player2;
                vSecondData = data2;
                console.log("one is first");
            } else {
                vFirst = player2;
                vFirstData = data2;
                vSecond = player1;
                vSecondData = data1;
                console.log("two is first");

            }

            // Event listener
            window.setInterval(function() {
                console.log("in event listener");
                console.log(vFirst.getCurrentTime());
                console.log(vSecondData.attr('data-sync'));
                console.log(vSecondData.attr('data-status'));

                if ((vFirst.getCurrentTime() >= vSecondData.attr('data-sync')) && (vSecondData.attr('data-status') == 'notPlaying')){ 
                    vSecond.mute();
                    vSecond.playVideo();
                    console.log('VIDEO PLAYING');
                    console.log(vFirst.getCurrentTime());
                    vSecondData.attr('data-status', "playing");
                }

                if ((vFirst.getPlayerState() == 0) && (vSecond.getPlayerState() == 1)) { // first is done playing
                    //unmute second
                    vSecond.unMute();
                }
            }, 200);

            vFirst.playVideo();
            data1.attr('data-status', 'playing');

            if ((data2.attr('data-status') == 'playing') && (data1.attr('data-status') == 'playing')) {
                vSecond.playVideo();
                vFirst.playVideo();
            }
        }
                  
        function onPauseClick(event) {
            player1.pauseVideo(); 
            player2.pauseVideo();
        }  
        



        // var done = false;
        // function onPlayerStateChange(event) {
        //     if (event.data == YT.PlayerState.PLAYING && !done) {
        //       setTimeout(startVideo, 4000);
        //       done = true;
        //     }
        // }

        // }
        // function startVideo() {
        //     // player.startVideo();



              
       

            init();

            </script>
</body>
</html>