<!DOCTYPE html>
<html lang="en">
<head>
    <title>Video Sync</title>
    <link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css">

    <style type="text/css">

    .span12{
    	background: black;
    	color: white;
    	padding: 20px 0;
    	text-align:center;
	}

    .span6, .span4{
		background: blue;
		color: white;
		padding: 20px 0;
		text-align:center;
		margin-top: 15px;
	}

	.span3{
    	background: purple;
    	color: white;
    	padding: 0px 0;
    	text-align:center;
    	margin-top: 15px;

	}
	.span8{
    	background: pink;
    	color: white;
    	padding: 0px 0;
    	text-align:center;
		margin-top: 15px;
	}

	.span5, .span7, .span2{
    	background: yellow;
    	color: black;
    	padding: 20px 0;
    	text-align:center;
		margin-top: 15px;
	}

	</style>

</head>

<body>

	<div class="container">

		<div class="row">
			<div class="span12">
				<h1>Video Sync</h1>
			</div>
		</div>

		<div class="row">
				<div class="span6">
		            <iframe id="iframe-1" height="350" width="450"
		                src={{video1.youtube_url}}>               
		            </iframe> 
		            <div>
		            	<h6> youtube url: {{video1.youtube_url}} </h6>
		            </div>
		        </div>
		        <div class="span6">
		            <iframe id="iframe-2" height="350" width="450"
		                src={{video2.youtube_url}}>               
		            </iframe> 
		            <div>
		            	<h6> youtube url: {{video2.youtube_url}} </h6>
		            </div>
		        </div>
		</div>

		<div class="row">
			<div class="span4">
				Title: {{video1.title}}
				Artist: {{video1.artist}}
				Event: {{video1.event}}
			</div>
			<div class="span8">
				<button id="playAll" class="btn" disabled>Play</button>
        		<button id="pauseAll" class="btn" disabled>Pause</button>
			</div>
		</div>	


		<div class="row">
			<div class="span8">
				<form class="form-horizontal">
					<div class="control-group">
						<label class="control-label" for="title">Title</label>
						<div class="controls">
							<input type="text" class="span3" name="title" placeholder="Title"/><br/>
						</div>
					</div>
					<div class="control-group">
				        <label class="control-label" for="artist">Artist</label>
						<div class="controls">
				        	<input type="text" class="span3" name="artist" placeholder="Artist"/><br/>
						</div>
					</div>

					<div class="control-group">
				        <label class="control-label" for="event">Event</label>
						<div class="controls">
				        	<input type="text" class="span3" name="event" placeholder="Event"/><br/>
						</div>
					</div>

				        <input type="file" class="span3" name="file1"><br/>
				        <input type="file" class="span3" name="file2"><br/>

				        <label class="control-label" for="url1">Youtube URL</label>
				        <input type="text" class="span3" name="url1" placeholder="Youtube URL"><br/>
				        <label class="control-label" for="url2">Youtube URL</label>
				        <input type="text" class="span3" name="url2" placeholder="Youtube URL"><br/>

				        <input type="submit" value="Upload and Analyze">
				        <button class="btn btn-primary" type="submit">Upload</button>
				        <button class="btn btn" type="submit">Upload</button>
				   
			    </form>
			</div>
			<div class="span4">
				{% for group in groups %}
					<div class="span2">
			            <h3>Group:{{group.id}}</h3>
			            {% for analysis in group.analysis_group %}
			                <h4>Sync Point:{{analysis.sync_point}}</h4>
			                <h4>Track:{{analysis.analysis_track.filename}}</h4>
			            {% endfor %}
			            <a href="/view_event?group_id={{group.id}}">View video group {{group.id}}</a>
		         	</div>
		        {% endfor %}
		    </div>
		</div>

	</div>










	</div>

    <script src="http://code.jquery.com/jquery-latest.js"></script>
	<script src="js/bootstrap.min.js"></script>
    <script type="text/javascript">

        // Youtube iframe API
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player1;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('iframe-1', {
                height: '390',
                width: '640',
                videoId: 'M7lc1UVf-VE',
                events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
                }
            });
        }

        var player2;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('iframe-2', {
                height: '390',
                width: '640',
                videoId: 'M7lc1UVf-VE',
                events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
                }
            });
        }


        function onPlayerReady(event) {
            event.target.playVideo();
        }

        var done = false;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !done) {
              setTimeout(startVideo, 4000);
              done = true;
            }

        }
        function startVideo() {
            // player.startVideo();
        }




            // var v1, v2, 
            var playButton, pauseButton;

            function init() {
                // v1 = $('#video-1');
                // v2 = $('#video-2');
                playButton = $("#playAll");
                pauseButton = $("#pauseAll");

                v1.on("canplaythrough", onPlayThrough);
                v2.on("canplaythrough", onPlayThrough);

                v1[0].load();  // 0 index to to access DOM element of jquery collection
                v2[0].load();

                playButton.on("click", onPlayClick);
                pauseButton.on("click", onPauseClick);

            }

            function onPlayThrough(event) {
                var video = event.currentTarget;
                video.readyToPlayNow = true;
                if (v1[0].readyToPlayNow && v2[0].readyToPlayNow) {
                    playButton.removeAttr('disabled');
                    pauseButton.removeAttr('disabled');
                }
            }
              

            function onPlayClick(event) {
                var vFirst, vSecond;

                if (Number(v1.attr('data-sync-point')) > (Number(v2.attr('data-sync-point')))) {
                    vFirst = v2;
                    vSecond = v1;
                } else {
                    vFirst = v1;
                    vSecond = v2
                }

                // Event listener
                vFirst.on("timeupdate", function() {
                    if (((vFirst[0].currentTime*1000) >= vSecond.attr('data-sync-point')) &&(vSecond.attr('data-status') == 'notPlaying')){ 
                        vSecond[0].play();
                        console.log('VIDEO PLAYING')
                        console.log(vFirst[0].currentTime*1000)
                        vSecond.attr('data-status', "playing");
                    }
                })
                vFirst[0].play();
                vFirst.attr('data-status', 'playing');

                if ((vSecond.attr('data-status') == 'playing') && (vFirst.attr('data-status') == 'playing')) {
                    vSecond[0].play();
                    vFirst[0].play();
                }
            }
                      
            function onPauseClick(event) {
                v1[0].pause(); 
                v2[0].pause();
            }         

            init();

            </script>
</body>
</html>