<!DOCTYPE html>
<html lang="en">
<head>
    <title>Video Sync</title>
    <link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css">

    <style type="text/css">

    .span12{
    	background: black;
    	color: white;
    	padding: 0px 0;
    	text-align:center;
	}

    .span6, .span4{
		background: blue;
		color: white;
		text-align:center;
		margin-top: 15px;
	}

	.span3{
    	background: purple;
    	color: white;
    	padding: 0px 0;
    	text-align:center;
    	margin-top: 15px;

	}
	.span8{
    	background: pink;
    	color: white;
    	text-align:center;
		margin-top: 15px;
	}

	.span5, .span7, .span2{
    	background: yellow;
    	color: black;
    	padding: 0px 0;
    	text-align:center;
		margin-top: 15px;
    }
    #data-2{
        margin-right: 0px;
        margin-left: 10px;

    }
    #playAll{
        border: 10px;


    }
	


	</style>

</head>

<body>

	<div class="container">

		<div class="row">
			<div class="span12">
				<h1>Video Sync</h1>
			</div>
		</div>

		<div class="row">
				<div id="data-1" class="span6" data-source="{{video1.youtube_url}}" data-sync="{{video1.analysis_track[0].sync_point}}" data-status="notPlaying">
		            <div id="iframe-1"></div>               
		        </div>
		        <div id="data-2" class="span6" data-source="{{video2.youtube_url}}" data-sync="{{video2.analysis_track[0].sync_point}}" data-status="notPlaying">
		            <div id="iframe-2"></div>
		        </div>
		</div>

		<div class="row">
			<div class="span4">
				Title: {{video1.title}}
				Artist: {{video1.artist}}
				Event: {{video1.event}}
			</div>
			<div class="span8">
				<button id="playAll" class="btn" disabled>Play</button>
        		<button id="pauseAll" class="btn" disabled>Pause</button>
			</div>
		</div>	


		<div class="row">
			<div class="span4">
				<form class="form-horizontal" method="post">
					<div class="control-group">
						<label class="control-label" for="title">Title</label>
						<div class="controls">
							<input type="text" class="span2" name="title" placeholder="Title"/><br/>
						</div>
					</div>
					<div class="control-group">
				        <label class="control-label" for="artist">Artist</label>
						<div class="controls">
				        	<input type="text" class="span2" name="artist" placeholder="Artist"/><br/>
						</div>
					</div>

					<div class="control-group">
				        <label class="control-label" for="event">Event</label>
						<div class="controls">
				        	<input type="text" class="span2" name="event" placeholder="Event"/><br/>
						</div>
					</div>

				        <input type="file" class="span3" name="file1"><br/>
				        <input type="file" class="span3" name="file2"><br/>

				        <label class="control-label" for="url1">Youtube URL</label>
				        <input type="text" class="span3" name="url1" placeholder="Youtube URL"><br/>
				        <label class="control-label" for="url2">Youtube URL</label>
				        <input type="text" class="span3" name="url2" placeholder="Youtube URL"><br/>

				        <button class="btn btn-primary" type="submit">Upload</button>
				   
			    </form>
			</div>
			<div class="span8">
				{% for group in groups %}
					<div class="row-fluid no-space">
			            <h3>Group:{{group.id}}</h3>
			            {% for analysis in group.analysis_group %}
                            <div class="span4">
			                <p>Sync Point:{{analysis.sync_point}}</p>
			                <p>Track:{{analysis.analysis_track.filename}}</p>
                            <img src="{{analysis.analysis_track.thumbnail_url}}" height="150" width="150"></img>
                            </div>
			            {% endfor %}
			            <a href="/view_event?group_id={{group.id}}">View video group {{group.id}}</a>
		         	</div>
		        {% endfor %}

		    </div>
                           
		</div>

	</div>










	</div>

    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script type="text/javascript">

        // Youtube iframe API
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player1, player2, data1, data2;
        var playButton, pauseButton;




        function init() {
            data1 = $("#data-1");
            data2 = $("#data-2");
            playButton = $("#playAll");
            pauseButton = $("#pauseAll");

            playButton.on("click", onPlayClick);
            pauseButton.on("click", onPauseClick);
        }

        // Create YouTube Iframe elements
        function onYouTubeIframeAPIReady() { // create function that creates similar elements
            player1 = new YT.Player('iframe-1', {
                height: '400',
                width: '470',
                videoId: data1.attr('data-source').split("embed/")[1],
                playerVars: {'autoplay': 0, 'controls': 1},
                events: {
                'onReady': onPlayerReady,
                // 'onStateChange': onPlayerStateChange
                }
            });

            player2 = new YT.Player('iframe-2', {
                height: '400',
                width: '470',
                videoId: data2.attr('data-source').split("embed/")[1],
                playerVars: {'autoplay': 0, 'controls': 1},
                events: {
                'onReady': onPlayerReady,
                // 'onStateChange': onPlayerStateChange
                }
            });
        }


        // Enable Play and Pause buttons if player1 and player2 videos have loaded 2%
        function onPlayerReady(event) {
            event.target.setPlaybackQuality("small")
            event.target.playVideo()
            event.target.pauseVideo()
            window.setInterval(function() {
                // console.log(event.target.getVideoLoadedFraction());
                if (event.target.getVideoLoadedFraction() > .02) {
                    event.target.readyToPlayNow = "true";
                }

                if ((player1.readyToPlayNow == "true") && (player2.readyToPlayNow == "true")) {
                    playButton.removeAttr('disabled');
                    pauseButton.removeAttr('disabled');
                    // player1.playVideo();
                    // player2.playVideo();
                }
            }, 500)
        }

        function onPlayClick(event) {
            var vFirst, vSecond;

            if (Number(data1.attr("data-sync")) < (Number(data2.attr("data-sync")))) {
                vFirst = player1; // player element
                vFirstData = data1; // dom element
                vSecond = player2;
                vSecondData = data2;
                console.log("one is first");
            } else {
                vFirst = player2;
                vFirstData = data2;
                vSecond = player1;
                vSecondData = data1;
                console.log("two is first");

            }

            // Event listener
            window.setInterval(function() {
                console.log("in event listener");
                console.log(vFirst.getCurrentTime());
                console.log(vSecondData.attr('data-sync'));
                console.log(vSecondData.attr('data-status'));

                if ((vFirst.getCurrentTime() >= vSecondData.attr('data-sync')) && (vSecondData.attr('data-status') == 'notPlaying')){ 
                    vSecond.mute();
                    vSecond.playVideo();
                    console.log('VIDEO PLAYING');
                    console.log(vFirst.getCurrentTime());
                    vSecondData.attr('data-status', "playing");
                }

                if ((vFirst.getPlayerState() == 0) && (vSecond.getPlayerState() == 1)) { // first is done playing
                    //unmute second
                    vSecond.unMute();
                }
            }, 200);

            vFirst.playVideo();
            data1.attr('data-status', 'playing');

            if ((data2.attr('data-status') == 'playing') && (data1.attr('data-status') == 'playing')) {
                vSecond.playVideo();
                vFirst.playVideo();
            }
        }
                  
        function onPauseClick(event) {
            player1.pauseVideo(); 
            player2.pauseVideo();
        }  
        



        // var done = false;
        // function onPlayerStateChange(event) {
        //     if (event.data == YT.PlayerState.PLAYING && !done) {
        //       setTimeout(startVideo, 4000);
        //       done = true;
        //     }
        // }

        // }
        // function startVideo() {
        //     // player.startVideo();



              
       

            init();

            </script>
</body>
</html>